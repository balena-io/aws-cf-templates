---
# Copyright 2018 widdix GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
AWSTemplateFormatVersion: '2010-09-09'
Description: 'VPC: Interface Endpoint, a cloudonaut.io template'
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'Parent Stacks'
      Parameters:
      - ParentVPCStack
      - ParentClientStack
      - ParentAlertStack
    - Label:
        default: 'Endpoint Parameters'
      Parameters:
      - ServiceName
Parameters:
  ParentVPCStack:
    Description: 'Stack name of parent VPC stack based on vpc/vpc-*azs.yaml template.'
    Type: String
  ParentClientStack:
    Description: 'Optional stack name of parent client stack based on state/client-sg.yaml template.'
    Type: String
    Default: ''
  ParentAlertStack:
    Description: 'Optional but recommended stack name of parent alert stack based on operations/alert.yaml template.'
    Type: String
    Default: ''
  ServiceName:
    Description: 'The name of the service.'
    Type: String
    AllowedValues: # generate list with aws --no-cli-pager --region us-east-1 ec2 describe-vpc-endpoint-services --query 'ServiceDetails[].ServiceName' | grep 'com.amazonaws.us-east-1.'
    - cassandra-streams
    - bcm-data-exports
    - emr-service-cell01
    - freetier
    - kendra-ranking
    - qbusiness
    - resource-explorer-2
    - resource-explorer-2-fips
    - experiments
    - notebook
    - partner-app
    - studio
    - access-analyzer
    - access-analyzer-fips
    - account
    - acm
    - acm-fips
    - acm-pca
    - acm-pca-fips
    - aiops
    - aiops-fips
    - airflow.api
    - airflow.api-fips
    - airflow.env
    - airflow.env-fips
    - airflow.ops
    - analytics-omics
    - analytics-omics-fips
    - apigateway
    - app-integrations
    - appconfig
    - appconfigdata
    - application-autoscaling
    - application-signals
    - applicationinsights
    - appmesh
    - appmesh-envoy-management
    - apprunner
    - apprunner.requests
    - appstream.api
    - appstream.streaming
    - appsync
    - appsync-api
    - apptest
    - aps
    - aps-workspaces
    - arc-region-switch
    - arc-region-switch-control-plane
    - arc-zonal-shift
    - arsenal-discovery
    - athena
    - athena-fips
    - auditmanager
    - autoscaling
    - autoscaling-fips
    - autoscaling-plans
    - awsconnector
    - b2bi
    - backup
    - backup-fips
    - backup-gateway
    - batch
    - bcm-pricing-calculator
    - bedrock
    - bedrock-agent
    - bedrock-agent-runtime
    - bedrock-agentcore
    - bedrock-agentcore.gateway
    - bedrock-data-automation
    - bedrock-data-automation-fips
    - bedrock-data-automation-runtime
    - bedrock-data-automation-runtime-fips
    - bedrock-fips
    - bedrock-runtime
    - bedrock-runtime-fips
    - billing
    - billingconductor
    - braket
    - cases
    - cassandra
    - cassandra-fips
    - ce
    - cleanrooms
    - cleanrooms-fips
    - cleanrooms-ml
    - cloudcontrolapi
    - cloudcontrolapi-fips
    - clouddirectory
    - cloudformation
    - cloudformation-fips
    - cloudhsmv2
    - cloudtrail
    - cloudtrail-fips
    - codeartifact.api
    - codeartifact.repositories
    - codebuild
    - codebuild-fips
    - codecommit
    - codecommit-fips
    - codeconnections.api
    - codedeploy
    - codedeploy-commands-secure
    - codedeploy-fips
    - codeguru-profiler
    - codeguru-reviewer
    - codepipeline
    - codestar-connections.api
    - codewhisperer
    - comprehend
    - comprehendmedical
    - compute-optimizer
    - config
    - connect-campaigns
    - console
    - control-storage-omics
    - control-storage-omics-fips
    - controlcatalog
    - controltower
    - controltower-fips
    - cost-optimization-hub
    - data-servicediscovery
    - data-servicediscovery-fips
    - databrew
    - databrew-fips
    - dataexchange
    - datasync
    - datasync-fips
    - datazone
    - datazone-fips
    - deadline.management
    - deadline.scheduling
    - detective
    - detective-fips
    - deviceadvisor.iot
    - devops-guru
    - dicom-medical-imaging
    - dilithium
    - diode
    - diode-fips
    - directconnect
    - directconnect-fips
    - discovery
    - dlm
    - dlm-fips
    - dms
    - dms-fips
    - drs
    - ds
    - ds-data
    - ds-data-fips
    - ds-fips
    - dsql
    - dsql-fnh4
    - dynamodb
    - dynamodb
    - dynamodb-fips
    - dynamodb-streams
    - ebs
    - ebs-fips
    - ec2
    - ec2-fips
    - ec2messages
    - ecr.api
    - ecr.dkr
    - ecs
    - ecs-agent
    - ecs-fips
    - ecs-telemetry
    - eks
    - eks-auth
    - eks-fips
    - eks-proxy
    - elastic-inference.runtime
    - elasticache
    - elasticache-fips
    - elasticbeanstalk
    - elasticbeanstalk-fips
    - elasticbeanstalk-health
    - elasticfilesystem
    - elasticfilesystem-fips
    - elasticloadbalancing
    - elasticloadbalancing-fips
    - elasticmapreduce
    - elasticmapreduce-fips
    - email-smtp
    - emr-containers
    - emr-serverless
    - emr-serverless-services.livy
    - emr-serverless.dashboard
    - emrwal.prod
    - entityresolution
    - entityresolution-fips
    - events
    - events-fips
    - evidently
    - evidently-dataplane
    - evs
    - evs-fips
    - execute-api
    - finspace
    - finspace-api
    - fis
    - fis-fips
    - fms
    - fms-fips
    - forecast
    - forecast-fips
    - forecastquery
    - forecastquery-fips
    - frauddetector
    - fsx
    - fsx-fips
    - gamelift
    - geo.geofencing
    - geo.maps
    - geo.metadata
    - geo.places
    - geo.routes
    - geo.tracking
    - git-codecommit
    - git-codecommit-fips
    - glue
    - glue.dashboard
    - grafana
    - grafana-workspace
    - greengrass
    - groundstation
    - groundstation-fips
    - guardduty
    - guardduty-data
    - guardduty-data-fips
    - guardduty-fips
    - healthlake
    - highlander
    - identitystore
    - imagebuilder
    - imagebuilder-fips
    - inspector-scan
    - inspector-scan-fips
    - inspector2
    - inspector2-fips
    - internetmonitor
    - internetmonitor-fips
    - invoicing
    - iot.credentials
    - iot.data
    - iot.fleethub.api
    - iotfleetwise
    - iotsitewise.api
    - iotsitewise.data
    - iottwinmaker.api
    - iottwinmaker.data
    - iotwireless.api
    - kafka
    - kafka-fips
    - kafkaconnect
    - kendra
    - kinesis-firehose
    - kinesis-firehose-fips
    - kinesis-streams
    - kinesis-streams-fips
    - kinesisanalytics
    - kinesisanalytics-fips
    - kms
    - kms-fips
    - lakeformation
    - lambda
    - launchwizard
    - license-manager
    - license-manager-fips
    - license-manager-linux-subscriptions
    - license-manager-linux-subscriptions-fips
    - license-manager-user-subscriptions
    - license-manager-user-subscriptions-fips
    - lightsail
    - logs
    - logs-fips
    - lookoutequipment
    - lookoutmetrics
    - lookoutvision
    - lorawan.cups
    - lorawan.lns
    - m2
    - macie2
    - macie2-fips
    - mail-manager
    - mail-manager-fips
    - mail-manager-smtp.auth.fips
    - mail-manager-smtp.open.fips
    - managedblockchain-query
    - managedblockchain.bitcoin.mainnet
    - managedblockchain.bitcoin.testnet
    - mediaconnect
    - mediaconvert
    - mediaconvert-fips
    - medical-imaging
    - memory-db
    - memorydb-fips
    - metering-marketplace
    - mgn
    - migrationhub-orchestrator
    - migrationhub-strategy
    - models-v2-lex
    - monitoring
    - mpa
    - mq
    - mq-fips
    - neptune-graph
    - neptune-graph-data
    - neptune-graph-fips
    - network-firewall
    - network-firewall-fips
    - networkflowmonitor
    - networkflowmonitorreports
    - networkmonitor
    - nimble
    - notifications
    - notifications-contacts
    - oam
    - observabilityadmin
    - odb
    - odb-fips
    - organizations
    - organizations-fips
    - outposts
    - panorama
    - payment-cryptography.controlplane
    - payment-cryptography.dataplane
    - pca-connector-ad
    - pca-connector-scep
    - pcs
    - pcs-fips
    - personalize
    - personalize-events
    - personalize-runtime
    - pi
    - pi-fips
    - pinpoint
    - pinpoint-sms-voice-v2
    - pipes
    - pipes-data
    - pipes-fips
    - polly
    - polly-fips
    - pricing.api
    - profile
    - proton
    - q
    - qapps
    - qldb.session
    - quicksight-website
    - ram
    - ram-fips
    - rbin
    - rds
    - rds-data
    - rds-fips
    - redshift
    - redshift-data
    - redshift-data-fips
    - redshift-fips
    - redshift-serverless
    - redshift-serverless-fips
    - refactor-spaces
    - rekognition
    - rekognition-fips
    - repostspace
    - resource-groups
    - resource-groups-fips
    - robomaker
    - rolesanywhere
    - rolesanywhere-fips
    - route53profiles
    - rum
    - rum-dataplane
    - runtime-medical-imaging
    - runtime-v2-lex
    - s3
    - s3
    - s3-outposts
    - s3express
    - s3tables
    - sagemaker-data-science-assistant
    - sagemaker.api
    - sagemaker.api-fips
    - sagemaker.featurestore-runtime
    - sagemaker.featurestore-runtime-fips
    - sagemaker.metrics
    - sagemaker.runtime
    - sagemaker.runtime-fips
    - scheduler
    - schemas
    - scn
    - secretsmanager
    - secretsmanager-fips
    - security-ir
    - securityhub
    - securityhub-fips
    - securitylake
    - securitylake-fips
    - serverlessrepo
    - service.user-subscriptions
    - servicecatalog
    - servicecatalog-appregistry
    - servicecatalog-fips
    - servicediscovery
    - servicediscovery-fips
    - servicequotas
    - shield
    - shield-fips
    - signin
    - simspaceweaver
    - snow-device-management
    - sns
    - sns-fips
    - social-messaging
    - social-messaging-fips
    - sqs
    - sqs-fips
    - ssm
    - ssm-contacts
    - ssm-incidents
    - ssm-incidents-fips
    - ssm-quicksetup
    - ssm-sap
    - ssm-sap-fips
    - ssmmessages
    - states
    - storage-omics
    - storagegateway
    - streaming-rekognition
    - streaming-rekognition-fips
    - sts
    - sts-fips
    - swf
    - swf-fips
    - sync-states
    - synthetics
    - synthetics-fips
    - tagging
    - tags-omics
    - tags-omics-fips
    - tax
    - textract
    - textract-fips
    - thinclient.api
    - timestream-influxdb
    - timestream-influxdb-fips
    - timestream.ingest-cell2
    - timestream.query-cell2
    - tnb
    - transcribe
    - transcribe-fips
    - transcribestreaming
    - transcribestreaming-fips
    - transfer
    - transfer-fips
    - transfer.server
    - transform
    - translate
    - trustedadvisor
    - uxc
    - verifiedpermissions
    - verifiedpermissions-fips
    - voiceid
    - vpc-lattice
    - wafv2
    - wafv2-fips
    - wellarchitected
    - wisdom
    - workflows-omics
    - workflows-omics-fips
    - workmail
    - workmailmessageflow
    - workspaces
    - workspaces-fips
    - workspaces-instances
    - workspaces-web
    - workspaces-web-fips
    - xray
    - xray-fips
Conditions:
  HasParentClientStack: !Not [!Equals [!Ref ParentClientStack, '']]
  HasAlertTopic: !Not [!Equals [!Ref ParentAlertStack, '']]
  UseEmailSMTP: !Equals [!Ref ServiceName, 'email-smtp']
Resources:
  SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: !Ref 'AWS::StackName'
      VpcId: {'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'}
      SecurityGroupIngress: !If
      - HasParentClientStack
      - !If
        - UseEmailSMTP
        - - IpProtocol: tcp
            FromPort: 25
            ToPort: 25
            SourceSecurityGroupId: {'Fn::ImportValue': !Sub '${ParentClientStack}-ClientSecurityGroup'}
          - IpProtocol: tcp
            FromPort: 465
            ToPort: 465
            SourceSecurityGroupId: {'Fn::ImportValue': !Sub '${ParentClientStack}-ClientSecurityGroup'}
          - IpProtocol: tcp
            FromPort: 587
            ToPort: 587
            SourceSecurityGroupId: {'Fn::ImportValue': !Sub '${ParentClientStack}-ClientSecurityGroup'}
          - IpProtocol: tcp
            FromPort: 2465
            ToPort: 2465
            SourceSecurityGroupId: {'Fn::ImportValue': !Sub '${ParentClientStack}-ClientSecurityGroup'}
          - IpProtocol: tcp
            FromPort: 2587
            ToPort: 2587
            SourceSecurityGroupId: {'Fn::ImportValue': !Sub '${ParentClientStack}-ClientSecurityGroup'}
        - - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            SourceSecurityGroupId: {'Fn::ImportValue': !Sub '${ParentClientStack}-ClientSecurityGroup'}
      - !If
        - UseEmailSMTP
        - - IpProtocol: tcp
            FromPort: 25
            ToPort: 25
            CidrIp: {'Fn::ImportValue': !Sub '${ParentVPCStack}-CidrBlock'}
          - IpProtocol: tcp
            FromPort: 465
            ToPort: 465
            CidrIp: {'Fn::ImportValue': !Sub '${ParentVPCStack}-CidrBlock'}
          - IpProtocol: tcp
            FromPort: 587
            ToPort: 587
            CidrIp: {'Fn::ImportValue': !Sub '${ParentVPCStack}-CidrBlock'}
          - IpProtocol: tcp
            FromPort: 2465
            ToPort: 2465
            CidrIp: {'Fn::ImportValue': !Sub '${ParentVPCStack}-CidrBlock'}
          - IpProtocol: tcp
            FromPort: 2587
            ToPort: 2587
            CidrIp: {'Fn::ImportValue': !Sub '${ParentVPCStack}-CidrBlock'}
        - - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: {'Fn::ImportValue': !Sub '${ParentVPCStack}-CidrBlock'}
  Endpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      PrivateDnsEnabled: true
      SecurityGroupIds: [!Ref SecurityGroup]
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.${ServiceName}'
      SubnetIds: !Split [',', {'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetsPrivate'}]
      VpcEndpointType: Interface
      VpcId: {'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'}
  AlarmEndpointPacketsDropped:
    Condition: HasAlertTopic
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: !Sub 'VPC Interface endpoint ${ServiceName} dropped packets. This could indicate that the endpoint or endpoint service is unhealthy.'
      Namespace: 'AWS/PrivateLinkEndpoints'
      MetricName: PacketsDropped
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      TreatMissingData: notBreaching
      AlarmActions:
      - {'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN'}
      Dimensions:
      - Name: 'Endpoint Type'
        Value: Interface
      - Name: 'Service Name'
        Value: !Sub 'com.amazonaws.${AWS::Region}.${ServiceName}'
      - Name: 'VPC Endpoint Id'
        Value: !Ref Endpoint
      - Name: 'VPC Id'
        Value: {'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'}
  AlarmEndpointRstPacketsReceived:
    Condition: HasAlertTopic
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: !Sub 'VPC Interface endpoint ${ServiceName} received RST packets. This could indicate that the endpoint service is unhealthy.'
      Namespace: 'AWS/PrivateLinkEndpoints'
      MetricName: RstPacketsReceived
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      TreatMissingData: notBreaching
      AlarmActions:
      - {'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN'}
      Dimensions:
      - Name: 'Endpoint Type'
        Value: Interface
      - Name: 'Service Name'
        Value: !Sub 'com.amazonaws.${AWS::Region}.${ServiceName}'
      - Name: 'VPC Endpoint Id'
        Value: !Ref Endpoint
      - Name: 'VPC Id'
        Value: {'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'}
  AlarmEndpointBandwidth:
    Condition: HasAlertTopic
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmActions:
      - {'Fn::ImportValue': !Sub '${ParentAlertStack}-TopicARN'}
      AlarmDescription: !Sub 'VPC Interface endpoint ${ServiceName} bandwidth utilization is over 80%'
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      Metrics:
      - Id: bytesProcessed
        Label: BytesProcessed
        MetricStat:
          Metric:
            Namespace: 'AWS/PrivateLinkEndpoints'
            MetricName: BytesProcessed # bytes per minute
            Dimensions:
            - Name: 'Endpoint Type'
              Value: Interface
            - Name: 'Service Name'
              Value: !Sub 'com.amazonaws.${AWS::Region}.${ServiceName}'
            - Name: 'VPC Endpoint Id'
              Value: !Ref Endpoint
            - Name: 'VPC Id'
              Value: {'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'}
          Period: 60
          Stat: Sum
        ReturnData: false
      - Expression: 'bytesProcessed/60*8/1000/1000/1000' # to Gbit/s
        Id: 'bandwidth'
        Label: 'Bandwidth'
        ReturnData: true
      Threshold: 80 # hard limit is 100 Gbit/s
      TreatMissingData: notBreaching
Outputs:
  TemplateID:
    Description: 'cloudonaut.io template id.'
    Value: 'vpc/vpc-endpoint'
  TemplateVersion:
    Description: 'cloudonaut.io template version.'
    Value: '__VERSION__'
  StackName:
    Description: 'Stack name.'
    Value: !Sub '${AWS::StackName}'
  Endpoint:
    Description: 'The VPC endpoint to a service.'
    Value: !Ref Endpoint
    Export:
      Name: !Sub '${AWS::StackName}-Endpoint'
